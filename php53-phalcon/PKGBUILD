_installdir_shared=opt/php53/shared
_installdir_bundled=opt/php53/bundled
pkgname=php53-devkit-both-phalcon
pkgver=phalcon.v1.3.2.r3.gbf9da26
pkgrel=1
pkgdesc="A high performance PHP web framework written as a C extension"
arch=(i686 x86_64)
[[ $CARCH == "i686" ]] && cd _arch=32bits || _arch=64bits
url=http://phalconphp.com/
license=(BSD)
depends=(php53-devkit-both)
makedepends=(git)
install=$pkgname.install
source=($pkgname::git://github.com/phalcon/cphalcon.git)
sha256sums=('SKIP')
sha512sums=('SKIP')

pkgver() {
    cd $pkgname/
    git describe --long --tags | sed -r 's/([^-]*-g)/r\1/;s/-/./g'
}

build() {
    export CFLAGS="-O2 -fno-delete-null-pointer-checks"
    export CPPFLAGS="-DPHALCON_RELEASE"

    [ ! -d "${srcdir}/build-shared" ] && cp -a ${srcdir}/$pkgname/ ${srcdir}/build-shared

    cd ${srcdir}/build-shared/build/$_arch/
    export EXTENSION_DIR=/${_installdir_shared}/lib/extensions
    /opt/php53/shared/bin/phpize
    ./configure --enable-phalcon --with-php-config=/opt/php53/shared/bin/php-config
    make

    [ ! -d "${srcdir}/build-bundled" ] && cp -a ${srcdir}/$pkgname/ ${srcdir}/build-bundled

    cd ${srcdir}/build-bundled/build/$_arch/
    export EXTENSION_DIR=/${_installdir_bundled}/lib/extensions
    /opt/php53/bundled/bin/phpize
    ./configure --enable-phalcon --with-php-config=/opt/php53/bundled/bin/php-config
    make
}

package() {
    install -D -m644 ${srcdir}/build-shared/build/$_arch/modules/phalcon.so ${pkgdir}/${_installdir_shared}/lib/extensions/phalcon.so
    install -D -m644 ${srcdir}/build-bundled/build/$_arch/modules/phalcon.so ${pkgdir}/${_installdir_bundled}/lib/extensions/phalcon.so
}
